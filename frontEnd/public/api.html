<!DOCTYPE html>
<html lang="en">
<head>    
    <link rel="stylesheet" href="./styles.css">    
    <link rel="icon" type="image/png" href="/icons/logo.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">    
    <script type="module">
        import { loadHTMLWithScriptAndCallback } from "./HTMLLoader.js";
        import { updateNavbarDisplay } from './navbar.js';

        // Function to initialize the map after the navbar
        function initialize() {
            // Load the navbar and update its display
            loadHTMLWithScriptAndCallback("navbar.html", "navbar", "navbar.js", () => {
                updateNavbarDisplay();
            });
        }

        // Ensure the api is loaded after all the scripts are ready
        window.addEventListener('load', initialize);
    </script>
    </script>    
    <title>Top Electronic Companies on NASDAQ</title>    
</head>
<body>
    <div class="page-container">
        <header>
          <div id="navbar"></div>      
        </header>
    
        <main>
            <h1>Top 5 Electronic Companies on NASDAQ</h1>

            <div class="stock-form-group">
                <input type="text" id="stockSymbolInput" class="stock-search-input" placeholder="Enter Stock Symbol...">
                <button id="searchButton" class="stock-search-button">Search</button>
            </div>
        
            <div class="stats-container" id="statsContainer">
                <!-- Company information will be displayed here -->
            </div>
        </main>
        <aside>
            <iframe width="560" height="315" src="https://www.youtube.com/embed/6LPzOJbdu-0" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
        </aside>
    
        <footer>
          <p>AREA @ 2024</p>
        </footer>
      </div>
    <script>
        // List of top 5 electronic companies on NASDAQ
        const companies = [
            { name: 'Apple', symbol: 'AAPL' },
            { name: 'Intel', symbol: 'INTC' },
            { name: 'NVIDIA', symbol: 'NVDA' },
            { name: 'Sony', symbol: 'SONY' },
            { name: 'HP', symbol: 'HPQ' }
        ];

        let apiKey;

        // Function to fetch API key from the server
        async function fetchApiKey() {
            try {
                const response = await fetch('/config');
                const data = await response.json();
                console.log(response);

                apiKey = data.apiKey;
                console.log(data);

            } catch (error) {
                console.error('Error fetching API key:', error);
            }
        }

        // Function to fetch and display company information
        async function fetchCompanyInfo(symbol) {
            const url = `https://api.polygon.io/v1/open-close/${symbol}/2023-06-21?adjusted=true&apiKey=${apiKey}`;

            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error('Stock not found');
                }
                const stockInfo = await response.json();

                return {
                    symbol: symbol,
                    close: stockInfo.close,
                    open: stockInfo.open
                };
            } catch (error) {
                console.error('Error fetching stock information:', error);
                return null;
            }
        }

        // Function to display company information
        async function displayCompanies() {
            const statsContainer = document.getElementById('statsContainer');
            statsContainer.innerHTML = '';

            for (const company of companies) {
                const companyInfo = await fetchCompanyInfo(company.symbol);
                if (companyInfo) {
                    const companyDiv = document.createElement('div');
                    companyDiv.classList.add('company-item');
                    companyDiv.innerHTML = `
                        <span><strong>${company.name} (${company.symbol})</strong></span>
                        <span>Current Price: $${companyInfo.close.toFixed(2)}</span>
                        <span>Opening Price: $${companyInfo.open.toFixed(2)}</span>
                    `;
                    statsContainer.appendChild(companyDiv);
                } else {
                    const errorDiv = document.createElement('div');
                    errorDiv.classList.add('company-item');
                    errorDiv.textContent = `Error fetching data for ${company.name} (${company.symbol})`;
                    statsContainer.appendChild(errorDiv);
                }
            }
        }

        // Function to display a searched stock symbol
        async function searchStockSymbol(symbol) {
            const statsContainer = document.getElementById('statsContainer');
            statsContainer.innerHTML = ''; // Clear existing data

            const companyInfo = await fetchCompanyInfo(symbol);
            if (companyInfo) {
                const companyDiv = document.createElement('div');
                companyDiv.classList.add('company-item');
                companyDiv.innerHTML = `
                    <span><strong>${symbol}</strong></span>
                    <span>Current Price: $${companyInfo.close.toFixed(2)}</span>
                    <span>Opening Price: $${companyInfo.open.toFixed(2)}</span>
                `;
                statsContainer.appendChild(companyDiv);
            } else {
                const errorDiv = document.createElement('div');
                errorDiv.classList.add('company-item');
                errorDiv.textContent = `Error fetching data for ${symbol}`;
                statsContainer.appendChild(errorDiv);
            }
        }

        // Fetch API key and display companies when the page loads
        fetchApiKey().then(displayCompanies);

        // Event listener for search button click
        document.getElementById('searchButton').addEventListener('click', function() {
            const symbol = document.getElementById('stockSymbolInput').value.trim().toUpperCase();
            if (symbol) {
                searchStockSymbol(symbol);
            } else {
                alert('Please enter a stock symbol');
            }
        });
    </script>
</body>
</html>
